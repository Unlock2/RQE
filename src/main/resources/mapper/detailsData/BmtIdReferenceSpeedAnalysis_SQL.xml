<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bmtIdReferenceSpeedAnalysis">

	<select id="getBmtIdList" parameterType="hashmap"  resultType="hashmap">
		select	distinct(bmtid) as bmtid 
		from 	gps_info
		where 	userid 
		in 		(
					select	userid
					from 	admin_user_list
					where 	adminid 
					in 		(
								select	adminid
								from 	admin_user_list
								where 	adminid = #{userid}
								or 		userid = #{userid}
							) -- 로그인 id
				)
		and 	to_date(substr(bmtid, 1, 6), 'yymmdd') 
		between to_date(#{start_date}, 'yyyy-mm-dd') 
		and 	to_date(#{end_date}, 'yyyy-mm-dd') -- 기간 검색
		and 	substr(bmtid, 8,2) not in ('00', '99') -- 출퇴근 제외
		order 	
		by 		bmtid
	</select>
	
	<select id="getTimeList" parameterType="hashmap" resultType="hashmap">
		select	bmtid
		, 		to_char(to_timestamp(min(gpstm),'yyyy-mm-dd hh24:mi:ss'),'hh24') as min_gpstm
		, 		to_char(to_timestamp(max(gpstm),'yyyy-mm-dd hh24:mi:ss'),'hh24') as max_gpstm
		from 	gps_info
		where 	userid 
		in 		(	
					select	userid
					from 	admin_user_list
					where 	adminid 
					in 		(
								select	adminid
								from 	admin_user_list
								where 	adminid = #{userid}
								or 		userid = #{userid}
							)
				)
		and 	to_date(substr(bmtid, 1, 6), 'yymmdd') 
		between to_date(#{start_date}, 'yyyy-mm-dd') 
		and 	to_date(#{end_date}, 'yyyy-mm-dd')
		and 	substr(bmtid, 8,2) not in ('00', '99')
		and 	bmtid = #{bmtid} -- bmtid
		group 
		by 		bmtid
	</select>
	
	
	<select id="selectGraph" parameterType="hashmap" resultType="hashmap">
		select	s_tm
		, 		cp_count
		, 		cp
		, 		carinfo
		, 		speed
		from	(
					select	*
					from 	standard_tm
					where 	hh = #{gpstm} -- 시간대
				) a 
		left outer join
				(
					select	bmtid
					, 		cp_count
					, 		c.cp
					, 		c.carinfo
					, 		gpstm
					, 		speed
					, 		to_char(to_timestamp(gpstm, 'yyyy-mm-dd hh24:mi:ss'),'hh24:mi:ss') as hhmmss
					from	(
								select	*
								from 	gps_info
								where	userid 
								in 		(
											select	userid
											from 	admin_user_list
											where 	adminid 
											in 		(
														select	adminid
														from 	admin_user_list
														where 	adminid = #{userid}
														or 		userid = #{userid}
													)
										)
								and 	to_date(substr(bmtid, 1, 6), 'yymmdd') 
								between to_date(#{start_date}, 'yyyy-mm-dd') 
								and 	to_date(#{end_date}, 'yyyy-mm-dd')
								and 	substr(bmtid, 8,2) not in ('00', '99')
								and 	bmtid = #{bmtid}
								and 	to_char(to_timestamp(gpstm,'yyyy-mm-dd hh24:mi:ss'),'hh24') = #{gpstm} -- 시간대
							) a,
							(
								select	count(*) as cp_count
								from	(
											select	userid
											from 	gps_info
											where 	userid 
											in 		(
														select	userid
														from 	admin_user_list
														where 	adminid 
														in 		(
																	select	adminid
																	from 	admin_user_list
																	where 	adminid = #{userid}
																	or 		userid = #{userid}
																)
													)
											and 	to_date(substr(bmtid, 1, 6), 'yymmdd') 
											between to_date(#{start_date}, 'yyyy-mm-dd') 
											and 	to_date(#{end_date}, 'yyyy-mm-dd')
											and 	substr(bmtid, 8,2) not in ('00', '99')
											and 	bmtid = #{bmtid}
											and 	to_char(to_timestamp(gpstm,'yyyy-mm-dd hh24:mi:ss'),'hh24') = #{gpstm} -- 시간대
											group by userid
										) a
							) b,
							(
								select	userid
								, 		cp
								, 		carinfo
								from 	bmt_total_info
								where 	bmtid = #{bmtid}
							) c
				where 	a.userid = c.userid
				order by	cp
				, 			gpstm
			) b
			on a.s_tm = b.hhmmss
	
	</select>
	
	
	
</mapper>